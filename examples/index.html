<head> </head>

<body>
    <!-- Insert these scripts at the bottom of the HTML, but before you use any Firebase services -->

    <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/7.8.2/firebase-app.js"></script>

    <!-- Add Firebase products that you want to use -->
    <script src="https://www.gstatic.com/firebasejs/7.8.2/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.8.2/firebase-firestore.js"></script>

    <script>
        // Your web app's Firebase configuration
        var firebaseConfig = {
            apiKey: "AIzaSyD4Y4Rb1detiPVFjoHtbhaSxWOo7KiEKjQ",
            authDomain: "dev1-amy-app.firebaseapp.com",
            databaseURL: "https://dev1-amy-app.firebaseio.com",
            projectId: "dev1-amy-app",
            storageBucket: "dev1-amy-app.appspot.com",
            messagingSenderId: "712940000014",
            appId: "1:712940000014:web:cc63c7d4c00e4ab9",
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig, "AMY");
    </script>

    <script>
        const tokenInfo = {
            token:
                "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJodHRwczovL2lkZW50aXR5dG9vbGtpdC5nb29nbGVhcGlzLmNvbS9nb29nbGUuaWRlbnRpdHkuaWRlbnRpdHl0b29sa2l0LnYxLklkZW50aXR5VG9vbGtpdCIsImlhdCI6MTU4MjEwMTcyNywiZXhwIjoxNTgyMTA1MzI3LCJpc3MiOiJkZXYxLWFteS1hcHBAYXBwc3BvdC5nc2VydmljZWFjY291bnQuY29tIiwic3ViIjoiZGV2MS1hbXktYXBwQGFwcHNwb3QuZ3NlcnZpY2VhY2NvdW50LmNvbSIsInVpZCI6IkphaXB1bmFfanVodV91c2VyMSIsImNsYWltcyI6eyJzY2hvb2xJZCI6IkphaXB1bmFfanVodSIsInJvbGUiOiJzdHVkZW50In19.C6fuZ9RRqPFtRPxBw6gSmFduLY9trmp0eaSk1ouw1jyRhfPLP3y1DS09_z5veShFj7bQdRcsTEI5Mlnfr14zcePFy9uA-iYe3b1bBFQdBuDvLtPXhZwo9cAirAWlw_uiaIsAmO-HrqW25zbc0qnnaZHYzrkxGXcB_R3xSBf-ha6jrWIRIK114YqqxHhBoGZlX8U7UM7l70ryJjBtt3LiaKMaYWCxq5Jpg0zgi7ys8pCihZ5X68LASGcYpMYb49kfO6nhMzPwp1B1pAFZ2B7Ry4Tc4V6HZfi0-DNcQeLTMaUhsKwlnwLGPtYfLBPXWNOdPFQbDQPeT2cG3TR9wpAUkg",
            amy_user_id: "Jaipuna_juhu_user1",
        };

        // We sign in via a temporary Firebase app to update the profile.
        firebase
            .app("AMY")
            .auth()
            .signInWithCustomToken(tokenInfo.token)
            .then(function(user) {
                console.log("singed in", user);

                document.getElementById("message").innerHTML = "DONE";
                return startAssignment();
            })
            .catch(function(error) {
                // Handle Errors here.
                var errorCode = error.code;
                var errorMessage = error.message;
                console.log("errorCode", errorCode);
                console.log("errorMessage", errorMessage);

                document.getElementById("message").innerHTML = "ERROR: Open console please";
            });

        async function startAssignment() {
            // you can use your own assignment ID if you want.
            // please pre-fix with your key
            const assignmentId = firebase
                .app("AMY")
                .firestore()
                .collection("StudentAssignments")
                .doc().id;
            console.log("assignmentId", assignmentId);

            const assignmentReference = firebase
                .app("AMY")
                .firestore()
                .collection("StudentAssignments")
                .doc(assignmentId);

            // create new assignment
            assignmentReference.set({
                startArchetypIds: ["PLUSA00000100001000"],
                studentId: tokenInfo.amy_user_id,
            });

            // START listening to the Database

            let assignmentSnap;
            let bubbleSnaps;

            // listen to changes in the Assignment
            assignmentReference.onSnapshot(_assignmentSnap => {
                assignmentSnap = _assignmentSnap;
                render(assignmentSnap, bubbleSnaps);
            });

            // list to changes to the bubbles
            firebase
                .app("AMY")
                .firestore()
                .collection("ExerciseBubbles")
                .orderBy("createdAt", "asc")
                .where("studentAssignmentId", "==", assignmentId)
                .where("studentId", "==", tokenInfo.amy_user_id)
                .onSnapshot(_bubbleSnaps => {
                    bubbleSnaps = _bubbleSnaps;
                    render(assignmentSnap, bubbleSnaps);
                });
        }
    </script>

    <script>
        function render(assignmentSnap, bubbleSnaps) {
            // we need both data to render something
            if (!assignmentSnap || !bubbleSnaps) {
                return;
            }

            if (!assignmentSnap.exists) {
                return;
            }

            if (!assignmentSnap.get("exercises") || assignmentSnap.get("exercises").length === 0) {
                return;
            }

            if (bubbleSnaps.length === 0) {
                return;
            }

            // --------------------------------------------------------
            // at this point we know we have all data we need to render

            // we need to check if the assignment already exists,
            // because we start listening before you are done
            // saving into the DB

            const id = assignmentSnap.id;
            const assignment = assignmentSnap.data();
            console.log("assignment", assignment);

            const unFinishedExercises = assignment.exercises.filter(ex => ex.state === "STARTED");

            const unFinishedExercise = unFinishedExercises[0];

            // only if we have an exercise we can display bubblel,
            // otherwise the user is most likely done with the assignment
            if (unFinishedExercise) {
                let bubbleHTML = ``;
                const studentExerciseId = unFinishedExercise.studentExerciseId;
                const bubbles = bubbleSnaps.docs.filter(bu => bu.data().studentExerciseId === studentExerciseId);

                for (const bubble of bubbles) {
                    if (bubble.data().moduleType === "QuestionBubble") {
                        bubbleHTML += `<div>${bubble.data().text}</div>`;
                    } else if (bubble.data().moduleType === "FeedbackBubble") {
                        bubbleHTML += `<div>${bubble.data().text}</div>`;
                    } else if (bubble.data().moduleType === "OptionBubble") {
                        let optionDiv = ``;
                        for (const option of bubble.data().options) {
                            optionDiv += `<div onClick=clickOption("${option.path}","${bubble.id}") >${option.text}</div>`;
                        }
                        bubbleHTML += `<div>${optionDiv}</div>`;
                    }
                }
                console.log("bubbles", bubbles);
                document.getElementById("message").innerHTML = bubbleHTML;
            }
        }
    </script>

    <script>
        function clickOption(selectedPath, bubbleId) {
            // set the path/option so AMY can update the data
            // and tell you if your selection was in/correct
            firebase
                .app("AMY")
                .firestore()
                .collection("ExerciseBubbles")
                .doc(bubbleId)
                .update({
                    selectedPath,
                });
        }
    </script>

    <div id="message"></div>
    <div id="bubbles"></div>
</body>
